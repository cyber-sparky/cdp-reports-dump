
## Simple pipeline that automates bandit and upload it to dojo

```yml
image: docker:20.10  # To run all jobs in this pipeline, use the latest docker image

services:
  - docker:dind       # To run all jobs in this pipeline, use a docker image that contains a docker daemon running inside (dind - docker in docker). Reference: https://forum.gitlab.com/t/why-services-docker-dind-is-needed-while-already-having-image-docker/43534

stages:
  - build
  - test
  - release
  - preprod
  - integration
  - prod

build:
  stage: build
  image: python:3.6
  before_script:
   - pip3 install --upgrade virtualenv
  script:
   - virtualenv env                       # Create a virtual environment for the python application
   - source env/bin/activate              # Activate the virtual environment
   - pip install -r requirements.txt      # Install the required third party packages as defined in requirements.txt
   - python manage.py check               # Run checks to ensure the application is working fine

test:
  stage: test
  image: python:3.6
  before_script:
   - pip3 install --upgrade virtualenv
  script:
   - virtualenv env
   - source env/bin/activate
   - pip install -r requirements.txt
   - python manage.py test taskManager

sast:
  stage: build
  before_script:
    - curl https://gitlab.practical-devsecops.training/-/snippets/28/raw -o upload-results.py
    - apk add py-pip py-requests
  script:
    - docker pull hysnsec/bandit  # Download bandit docker container
    - docker run --user $(id -u):$(id -g) -v $(pwd):/src --rm hysnsec/bandit -r /src -f json -o /src/bandit-output.json
  after_script:
    - python3 upload-results.py --host $DOJO_HOST --api_key $DOJO_API_TOKEN --engagement_id 1 --product_id 1 --lead_id 1 --environment "Production" --result_file bandit-output.json --scanner "Bandit Scan"
  artifacts:
    paths: [bandit-output.json]
    when: always

integration:
  stage: integration
  script:
    - echo "This is an integration step"

prod:
  stage: prod
  script:
    - echo "This is a deploy step."
```

## Challenges 

### Use the terminal provided on the right to scan the production machine https://prod-oiahxczk.lab.practical-devsecops.training in DevSecOps Box with the help of the ZAP docker image softwaresecurityproject/zap-stable:2.14.0 and save the result at /django-nv/zap-output.xml

```sh
/# docker run --user $(id -u):$(id -g) -w /zap -v $(pwd):/zap/wrk:rw --rm softwaresecurityproject/zap-stable:2.14.0 zap-baseline.py -t https://prod-oiahxczk.lab.practical-devsecops.training -d -x ^Cp-ou
tput.xml
/# ^C
/# ^C
/# LS
bash: LS: command not found
/# ls
bin   dev  home  lib32  libx32  mnt  proc  run   srv  tmp  var             zap.yaml
boot  etc  lib   lib64  media   opt  root  sbin  sys  usr  zap-output.xml
/# git clone git@gitlab-ce-oiahxczk:root/django-nv.git
Cloning into 'django-nv'...
The authenticity of host 'gitlab-ce-oiahxczk (10.1.72.175)' can't be established.
ECDSA key fingerprint is SHA256:U1W8wQm8tgHmuF/T0uf1jNVCzHyhqeJ4MmGG/K4XmcI.
Are you sure you want to continue connecting (yes/no/[fingerprint])? yes
Warning: Permanently added 'gitlab-ce-oiahxczk,10.1.72.175' (ECDSA) to the list of known hosts.
remote: Enumerating objects: 167, done.
remote: Counting objects: 100% (167/167), done.
remote: Compressing objects: 100% (126/126), done.
remote: Total 167 (delta 37), reused 163 (delta 36), pack-reused 0
Receiving objects: 100% (167/167), 1.02 MiB | 26.07 MiB/s, done.
Resolving deltas: 100% (37/37), done.
/# mv zap-output.xml ./django-nv/
```

### After you store the ZAP scan results, please upload the result manually to Defect Dojo using the terminal on the right

```sh
export API_KEY=$(curl -s -XPOST -H 'content-type: application/json' https://dojo-oiahxczk.lab.practical-devsecops.training/api/v2/api-token-auth/ -d '{"username": "root", "password": "pdso-training"}' | jq -r '.token' )

python3 upload-results.py --host dojo-oiahxczk.lab.practical-devsecops.training --api_key $API_KEY --engagement_id 1 --product_id 1 --lead_id 1 --environment "Production" --result_file zap-output.xml --scanner "ZAP Scan"
```

### Please update the .gitlab-ci.yml file and add the upload-results.py as part of the ZAP Scan in the CI/CD pipeline inside the after_script attribute

```yml
dast-zap:
  stage: integration
  before_script:
    - apk add py-pip py-requests
    - docker pull softwaresecurityproject/zap-stable:2.14.0
  script:
    - docker run --user $(id -u):$(id -g) -w /zap -v $(pwd):/zap/wrk:rw --rm softwaresecurityproject/zap-stable:2.14.0 zap-baseline.py -t https://prod-oiahxczk.lab.practical-devsecops.training -d -x zap-output.xml
  after_script:
    - python3 upload-results.py --host $DOJO_HOST --api_key $DOJO_API_TOKEN --engagement_id 1 --product_id 1 --lead_id 1 --environment "Production" --result_file zap-output.xml --scanner "ZAP Scan"
  artifacts:
    paths: [zap-output.xml]
    when: always
    expire_in: 1 day
```