
## Detecting a CSRF vulnerability 

```sh
cat > csrf_hunting.yaml <<EOF
rules:
- id: possible-csrf
  patterns:
  - pattern-inside: | 
      @csrf_exempt
      def \$FUNC(\$X):
          ...
  message: |
    Possible CSRF
  languages:
  - python
  severity: WARNING

- id: no-csrf-middleware
  patterns:
  - pattern: MIDDLEWARE_CLASSES=(...)
  - pattern-not: MIDDLEWARE_CLASSES=(...,'django.middleware.csrf.CsrfViewMiddleware',...)
  message: |
    No CSRF middleware
  languages:
  - python
  severity: WARNING
EOF
```

- **possible-csrf:** Find all function definitions that use @csrf_exempt as decorator
- **no-csrf-middleware:** Search the string MIDDLEWARE_CLASSES and see if doesn’t have ‘django.middleware.csrf.CsrfViewMiddleware’ on it

## Rule for detecting debug=true in django app

```sh
cat > debug_enable.yaml <<EOF 
rules:
- id: debug-enabled
  patterns:
  - pattern: DEBUG=True
  message: |
    Detected Django app with DEBUG=True. Do not deploy to production with this flag enabled
    as it will leak sensitive information.
  metadata:
    cwe: 'CWE-489: Active Debug Code'
    owasp: 'A6: Security Misconfiguration'
    references:
    - https://blog.scrt.ch/2018/08/24/remote-code-execution-on-a-facebook-server/
  severity: WARNING
  languages:
  - python
EOF
```

## Scan using rules from semgrep community 

Semgrep team have ported different toolset's rules like bandit, gosec to semgrep rule 

```sh
semgrep --config "p/bandit" .
```

## Challenge 

### Write a semgrep rule to detect Insecure Redirect in the following code snippet

```yml
rules:
  - id: insecure-redirect-detection
    message: "Insecure Redirect detected"
    severity: ERROR
    languages:
      - python
    pattern-either:
      - pattern: |
          return redirect(request.GET.get($VAR, ...))
      - pattern: |
          return redirect(request.POST.get($VAR, ...))
    metadata:
      cwe: "CWE-601"
      owasp: "A10:2017"
```